<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SMSé–‹ç«‹äº‹é …æŸ¥è©¢åŠAIå¯©æŸ¥ç³»çµ±</title>
    <style>
        /* Reset / åŸºæœ¬ */
        *, *::before, *::after { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            scrollbar-gutter: stable;
        }

        .app { max-width: 1800px; margin: 0 auto; background: white; min-height: 100vh; display: flex; flex-direction: column; height: 100vh; }
        .header { background: white; border-bottom: 3px solid #52a3cc; padding: 18px 22px; text-align: center; flex: 0 0 auto; }
        .header h1 { font-size: 26px; color: #333; display: inline-flex; align-items: center; gap: 10px; margin: 0; }
        .icon { background: #52a3cc; color: white; border-radius: 8px; padding: 6px; font-size: 20px; display:inline-flex; align-items:center; justify-content:center; }
        .data-updated { font-size: 13px; color: #666; margin-top: 6px; display: block; }

        .main { padding: 18px 20px; display: flex; flex-direction: column; gap: 12px; flex: 1 1 auto; overflow: auto; }
        .search-section { background: #e8e8e8; padding: 14px; border-radius: 8px; margin-bottom: 0; flex: 0 0 auto; }
        .search-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; }
        .search-group { display:flex; flex-direction:column; }
        .search-group label { font-size: 13px; font-weight:600; color:#333; margin-bottom:6px; }
        .search-group select, .search-group input { padding: 8px 10px; border-radius:6px; border:1px solid #cfcfcf; background:white; font-size:14px; }

        .button-group { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
        .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:700; font-size:13px; }
        .btn-search { background:#52a3cc; color:white; }
        .btn-reset { background:#6c757d; color:white; }
        .btn-export { background:#f0ad4e; color:white; }
        .btn-ai-all { background:#6f42c1; color:white; }

        .stats-section { display:none; margin:0; flex: 0 0 auto; }
        .stats-grid { display:flex; gap:10px; }
        .stat-card { flex:1 1 0; padding:10px 12px; border-radius:8px; color:white; font-weight:800; display:flex; flex-direction:column; justify-content:center; }
        .stat-card.blue { background:#52a3cc; }
        .stat-card.red { background:#d9534f; }
        .stat-card.green { background:#5cb85c; }
        .stat-number { font-size:22px; }

        .results-section { background:white; padding:8px; border-radius:8px; border:1px solid #e6e6e6; flex: 1 1 auto; min-height: 200px; }
        .results-header { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; }
        .results-title { font-weight:800; font-size:15px; }
        .table-container { border:1px solid #ddd; border-radius:6px; overflow: visible; }
        .table-wrapper { overflow-x: auto; }
        table { width:100%; border-collapse: collapse; min-width:1100px; font-size:13px; }
        th { position: sticky; top:0; z-index:5; background:#4a5568; color:white; padding:10px; text-align:left; font-weight:700; white-space:nowrap; }
        td { padding:10px; border-bottom:1px solid #f2f2f2; vertical-align:top; }

        .clickable-row { transition: background 0.12s ease; }
        .clickable-row:hover,
        .clickable-row:focus-visible {
            background: #fff6d9;
            cursor: pointer;
            outline: none;
        }
        tr:hover { background: #fafafa; }

        .preview-cell, .content-preview { max-width:320px; word-break:break-word; cursor:default; }
        .status-badge { padding:4px 10px; border-radius:12px; font-size:12px; font-weight:700; color:white; display:inline-block; }
        .status-active { background:#d9534f; }
        .status-resolved { background:#5cb85c; }
        .status-self { background:#f0ad4e; color:#fff; }

        .ai-badge { padding:4px 8px; border-radius:12px; font-size:12px; font-weight:700; color:white; display:inline-block; }
        .ai-yes { background:#28a745; }
        .ai-no  { background:#dc3545; }
        .ai-done { background:#2e8b57; }
        .ai-pending { background:#ffc107; color:#333; }
        .ai-fail { background:#6c2630; }

        .btn-sm { padding:6px 10px; border-radius:6px; cursor:pointer; border:none; font-weight:700; }
        .btn-ai { background:#6f42c1; color:white; }

        .empty-message { text-align:center; padding:26px; color:#666; }

        .modal-backdrop { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); z-index:1200; align-items:center; justify-content:center; padding:16px; }
        .modal-backdrop.open { display:flex; }
        .modal-panel { background:white; width:100%; max-width:1200px; max-height:calc(100vh - 40px); border-radius:8px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.25); display:flex; flex-direction:column; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 18px; border-bottom:1px solid #eee; flex: 0 0 auto; }
        .modal-title { font-weight:800; font-size:18px; }
        .modal-close { background:transparent; border:none; font-size:20px; cursor:pointer; color:#666; }
        .modal-body { padding:14px 18px; overflow:auto; flex: 1 1 auto; }

        .detail-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:10px; margin-bottom:12px; }
        .detail-item { background:#f8f9fa; padding:10px; border-radius:6px; border-left:4px solid #52a3cc; }
        .detail-label { font-weight:700; margin-bottom:6px; color:#333; font-size:13px; }
        .detail-value { color:#444; font-size:13px; line-height:1.6; word-break:break-word; }

        .round-container { margin-bottom:12px; background:#fff; border-radius:6px; border:1px solid #f1f1f1; }
        .round-header { padding:8px 10px; background:linear-gradient(90deg,#f0fbf6,#eef8f2); font-weight:700; color:#175a2f; border-bottom:1px solid #f5f5f5; }
        .round-body { padding:10px; color:#333; font-size:13px; }

        .ai-analysis-section { margin-top:12px; background:#f0f8ff; border-radius:6px; padding:10px; }
        .ai-analysis-section h4 { margin:0 0 8px 0; color:#0b5fa5; }
        .ai-note { font-size:13px; color:#333; }

        .modal-footer { padding:10px 16px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:8px; background:#fafafa; flex: 0 0 auto; }

        .spinner { display:inline-block; width:14px; height:14px; border:2px solid #fff; border-radius:50%; border-top-color: rgba(0,0,0,0.2); animation:spin 0.8s linear infinite; vertical-align:middle; margin-right:6px; }
        @keyframes spin { to { transform:rotate(360deg); } }

        /* é•·æ–‡å­—æ¬„ä½çš„é¡¯ç¤ºæ¨£å¼ï¼ˆæ‘˜è¦ + æ›´å¤šæŒ‰éˆ•ï¼‰ */
        .cell-wrapper { position: relative; max-width:420px; }
        .cell-short {
            max-height: 3.6em; /* å¤§ç´„å±•ç¤ºå…©è¡Œï¼ˆä¾ font-sizeï¼‰*/
            overflow: hidden;
            transition: max-height .22s ease;
            position: relative;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.8em;
        }
        .cell-short.has-more::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 1.2em;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.95) 60%, #fff 100%);
            pointer-events: none;
        }
        .cell-full {
            display: none;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .cell-full.open {
            display: block;
        }
        .cell-controls {
            display:flex;
            gap:6px;
            margin-top:6px;
            align-items:center;
        }
        .more-btn {
            background: transparent;
            border: 1px solid #cfcfcf;
            color: #0b5fa5;
            padding:4px 8px;
            border-radius:6px;
            font-size:12px;
            cursor:pointer;
        }

        @media (max-width: 980px) {
            .modal-panel { max-width: 92%; }
            table { font-size:12px; }
            .search-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
            .cell-wrapper { max-width:260px; }
        }
        @media (max-width: 680px) {
            .header h1 { font-size:18px; gap:8px; }
            .data-updated { font-size:12px; }
            table { min-width: 1000px; font-size:12px; }
            .modal-panel { width:100%; height:100%; max-width:100%; max-height:100%; border-radius:0; }
            .modal-body { padding:12px; }
            .cell-wrapper { max-width:180px; }
        }
    </style>
</head>
<body>
    <div class="app" id="appRoot">
        <div class="header">
            <h1><span class="icon">ğŸš„</span>SMSé–‹ç«‹äº‹é …æŸ¥è©¢åŠAIå¯©æŸ¥ç³»çµ±</h1>
            <span id="dataUpdated" class="data-updated">è³‡æ–™åº«æ›´æ–°ï¼š-</span>
        </div>

        <div class="main">
            <div class="search-section" role="region" aria-label="æŸ¥è©¢æ¢ä»¶">
                <div class="search-grid">
                    <div class="search-group"><label for="filterYear">å¹´åº¦</label><select id="filterYear"><option value="">å…¨éƒ¨</option></select></div>
                    <div class="search-group"><label for="filterUnit">éµè·¯æ©Ÿæ§‹</label><select id="filterUnit"><option value="">å…¨éƒ¨</option></select></div>
                    <div class="search-group"><label for="filterCategory">äº‹é …é¡åˆ¥</label><select id="filterCategory"><option value="">å…¨éƒ¨</option><option value="ç¼ºå¤±äº‹é …">ç¼ºå¤±äº‹é …</option><option value="è§€å¯Ÿäº‹é …">è§€å¯Ÿäº‹é …</option><option value="å»ºè­°äº‹é …">å»ºè­°äº‹é …</option></select></div>
                    <div class="search-group"><label for="filterInspectionCategory">æª¢æŸ¥é¡åˆ¥</label><select id="filterInspectionCategory"><option value="">å…¨éƒ¨</option></select></div>
                    <div class="search-group"><label for="filterDivision">åˆ†çµ„</label><select id="filterDivision"><option value="">å…¨éƒ¨</option></select></div>
                    <div class="search-group"><label for="filterStatus">ç‹€æ…‹</label><select id="filterStatus"><option value="">å…¨éƒ¨</option><option value="æŒçºŒåˆ—ç®¡">æŒçºŒåˆ—ç®¡</option><option value="è§£é™¤åˆ—ç®¡">è§£é™¤åˆ—ç®¡</option><option value="è‡ªè¡Œåˆ—ç®¡">è‡ªè¡Œåˆ—ç®¡</option></select></div>
                    <div class="search-group" style="grid-column:1 / -1;"><label for="filterKeyword">é—œéµå­—æœå°‹</label><input id="filterKeyword" type="text" placeholder="è¼¸å…¥ç·¨è™Ÿæˆ–å…§å®¹é—œéµå­—..."></div>
                </div>

                <div class="button-group" aria-hidden="false">
                    <button class="btn btn-search" onclick="window.searchData()">ğŸ” é–‹å§‹æœå°‹</button>
                    <button class="btn btn-reset" onclick="window.resetQueryFilters()">ğŸ”„ é‡è¨­</button>
                    <button class="btn btn-export" onclick="window.exportQueryCSV()">ğŸ“Š åŒ¯å‡ºCSV</button>
                    <button class="btn btn-ai-all" onclick="window.analyzeAllDisplayed()">ğŸ–¥ï¸ ä¸€éµAIåˆ†æï¼ˆç›®å‰çµæœï¼‰</button>
                </div>
            </div>

            <div id="statsSection" class="stats-section" aria-live="polite">
                <div class="stats-grid">
                    <div class="stat-card blue"><div id="totalCount" class="stat-number">0</div><div>ç¸½è¨ˆ</div></div>
                    <div class="stat-card red"><div id="activeCount" class="stat-number">0</div><div>åˆ—ç®¡ä¸­</div></div>
                    <div class="stat-card green"><div id="resolvedCount" class="stat-number">0</div><div>å·²è§£é™¤/è‡ªè¡Œåˆ—ç®¡</div></div>
                </div>
            </div>

            <div id="resultsSection" class="results-section" role="region" aria-label="æŸ¥è©¢çµæœ">
                <div class="results-header">
                    <div class="results-title">ğŸ“‹ æŸ¥è©¢çµæœ <span id="resultCount">(0 ç­†è³‡æ–™)</span></div>
                    <div class="muted">é»é¸åˆ—æˆ–æŒ‰ã€ŒAIåˆ†æã€æ‰“é–‹è©³ç´°è¦–çª—</div>
                </div>

                <div class="table-container" aria-live="polite">
                    <div class="table-wrapper">
                        <table id="queryTable" role="table" aria-label="æŸ¥è©¢è¡¨æ ¼">
                            <thead>
                                <tr>
                                    <th>å¹´åº¦</th>
                                    <th>éµè·¯æ©Ÿæ§‹</th>
                                    <th>ç·¨è™Ÿ</th>
                                    <th>äº‹é …é¡åˆ¥</th>
                                    <th>æª¢æŸ¥é¡åˆ¥</th>
                                    <th>åˆ†çµ„</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>å…§å®¹</th>
                                    <th>è¾¦ç†æƒ…å½¢</th>
                                    <th>æœ€æ–°å¯©æŸ¥æ„è¦‹</th>
                                    <th>AIåˆ†ææ‘˜è¦</th>
                                </tr>
                            </thead>
                            <tbody id="queryTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="queryMessage" class="empty-message" style="display:none;"></div>
        </div>
    </div>

    <!-- æ¨¡æ…‹è¦–çª—ï¼ˆè¦†è“‹ï¼‰ -->
    <div id="detailModalBackdrop" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
        <div class="modal-panel" role="document">
            <div class="modal-header">
                <div class="modal-title">é–‹ç«‹äº‹é …è©³ç´°è³‡æ–™</div>
                <div><button class="modal-close" aria-label="é—œé–‰" id="modalCloseBtn">âœ•</button></div>
            </div>
            <div class="modal-body">
                <div class="detail-grid" id="modalDetailGrid">
                    <div class="detail-item"><div class="detail-label">å¹´åº¦</div><div class="detail-value" id="viewYear">-</div></div>
                    <div class="detail-item"><div class="detail-label">éµè·¯æ©Ÿæ§‹</div><div class="detail-value" id="viewUnit">-</div></div>
                    <div class="detail-item"><div class="detail-label">ç·¨è™Ÿ</div><div class="detail-value" id="viewNumber">-</div></div>
                    <div class="detail-item"><div class="detail-label">äº‹é …é¡åˆ¥</div><div class="detail-value" id="viewCategory">-</div></div>
                    <div class="detail-item"><div class="detail-label">æª¢æŸ¥é¡åˆ¥</div><div class="detail-value" id="viewInspectionCategory">-</div></div>
                    <div class="detail-item"><div class="detail-label">åˆ†çµ„</div><div class="detail-value" id="viewDivision">-</div></div>
                    <div class="detail-item" style="grid-column: span 2;"><div class="detail-label">åˆ—ç®¡ç‹€æ…‹</div><div class="detail-value" id="viewStatus">-</div></div>
                    <div class="detail-item" style="grid-column: 1 / -1;"><div class="detail-label">å…§å®¹</div><div class="detail-value" id="viewContent"></div></div>
                </div>

                <div id="modalRounds"></div>

                <div class="ai-analysis-section" id="modalAISection">
                    <h4>ğŸ”® AIå”åŠ©åˆ¤æ–·ï¼ˆåƒè€ƒç”¨ï¼‰</h4>
                    <div class="ai-note"><strong>æ˜¯å¦ç¬¦åˆæ”¹å–„æ–¹å‘ï¼š</strong><span id="aiFulfill">å°šæœªåˆ†æ</span></div>
                    <div class="ai-note" style="margin-top:8px;"><strong>åˆ†æèªªæ˜ï¼š</strong><div id="aiReason" style="margin-top:6px;color:#222;"></div></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm" id="reAnalyzeBtn" style="background:#17a2b8;color:white;">ğŸ” é‡æ–°åˆ†æ</button>
                <button class="btn btn-sm" id="modalCloseBtn2" style="background:#6c757d;color:white;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- ä¿æŒåŸå§‹è³‡æ–™ä¾†æºçš„ script -->
    <script src="https://rbgov-my.sharepoint.com/personal/hckuo_rb_gov_tw/_layouts/15/download.aspx?UniqueId=e2684913-5be9-4093-b270-1da5f074848d"></script>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let queryDatabase = [];
        let filteredData = [];
        let currentDetailId = null;

        // å¯èª¿æ•´çš„å­—æ•¸é™åˆ¶ï¼ˆä¾éœ€æ±‚ä¿®æ”¹ï¼‰
        const MAX_CHARS = {
            content: 160,    // å…§å®¹æ¬„ä½é è¨­é¡¯ç¤ºå­—æ•¸ï¼ˆè¶…éæœƒæˆªæ–·ï¼‰
            handling: 140,   // è¾¦ç†æƒ…å½¢æ¬„ä½é è¨­é¡¯ç¤ºå­—æ•¸
            review: 140      // æœ€æ–°å¯©æŸ¥æ„è¦‹æ¬„ä½é è¨­é¡¯ç¤ºå­—æ•¸
        };

        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
        });

        function initializeSystem() {
            loadQueryData();
            displayInitialQueryData();
            updateDataTimestampDisplay();
            document.getElementById('filterKeyword').addEventListener('keypress', function(e){ if (e.key === 'Enter') searchData(); });
            // Modal close handlers
            document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
            document.getElementById('modalCloseBtn2').addEventListener('click', closeModal);
            document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeModal(); });
            document.getElementById('detailModalBackdrop').addEventListener('click', function(e){
                if (e.target === this) closeModal();
            });
            document.getElementById('reAnalyzeBtn').addEventListener('click', function(){ if (currentDetailId) analyzeItem(currentDetailId); });
        }

        function loadQueryData() {
            try {
                if (typeof window.railwayData !== 'undefined' && Array.isArray(window.railwayData.data)) {
                    queryDatabase = window.railwayData.data.map(function(item, index){ return { ...item, id: item.id || (index+1), aiResult: item.aiResult || null }; });
                    initializeQueryFilters();
                } else {
                    showMessage('æ‰¾ä¸åˆ° Railway_data.js æˆ–æª”æ¡ˆæ ¼å¼ä¸ç¬¦', 'error');
                }
            } catch (e) {
                showMessage('è¼‰å…¥æŸ¥è©¢è³‡æ–™å¤±æ•—: ' + e.message, 'error');
            }
        }

        function updateDataTimestampDisplay() {
            const el = document.getElementById('dataUpdated');
            try {
                if (typeof window.railwayData !== 'undefined') {
                    if (window.railwayData.convertedAt) {
                        el.textContent = `è³‡æ–™åº«æ›´æ–°ï¼š${window.railwayData.convertedAt}`;
                    } else if (window.railwayData.timestamp) {
                        const dt = new Date(window.railwayData.timestamp);
                        if (!isNaN(dt)) el.textContent = `è³‡æ–™åº«æ›´æ–°ï¼š${dt.toLocaleString('zh-TW')}`;
                        else el.textContent = `è³‡æ–™åº«æ›´æ–°ï¼š${window.railwayData.timestamp}`;
                    } else {
                        el.textContent = 'è³‡æ–™åº«æ›´æ–°ï¼šæœªçŸ¥';
                    }
                } else {
                    el.textContent = 'è³‡æ–™åº«æ›´æ–°ï¼šæ‰¾ä¸åˆ° railwayData';
                }
            } catch (e) {
                el.textContent = 'è³‡æ–™åº«æ›´æ–°ï¼šç„¡æ³•è§£ææ™‚é–“';
            }
        }

        function initializeQueryFilters() {
            function populateDropdown(elementId, values) {
                const select = document.getElementById(elementId);
                select.innerHTML = '<option value="">å…¨éƒ¨</option>' + [...values].map(v => `<option value="${v}">${v}</option>`).join('');
            }
            populateDropdown('filterYear', new Set(queryDatabase.map(i => i.year).filter(Boolean).sort((a,b)=>b-a)));
            populateDropdown('filterUnit', new Set(queryDatabase.map(i => i.unit).filter(Boolean).sort()));
            populateDropdown('filterInspectionCategory', new Set(queryDatabase.map(i => i.inspectionCategoryName).filter(Boolean).sort()));
            populateDropdown('filterDivision', new Set(queryDatabase.map(i => i.divisionName).filter(Boolean).sort()));
        }

        function displayInitialQueryData() {
            if (queryDatabase.length === 0) {
                document.getElementById('queryTableBody').innerHTML = `<tr><td colspan="11" class="empty-message">è³‡æ–™åº«ç„¡è³‡æ–™</td></tr>`;
                return;
            }
            filteredData = [...queryDatabase];
            displayQueryResults(sortQueryResults(filteredData));
            updateStatistics(filteredData);
            document.getElementById('statsSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'block';
        }

        function searchData() {
            const filters = {
                year: document.getElementById('filterYear').value,
                unit: document.getElementById('filterUnit').value,
                category: document.getElementById('filterCategory').value,
                inspectionCategory: document.getElementById('filterInspectionCategory').value,
                division: document.getElementById('filterDivision').value,
                status: document.getElementById('filterStatus').value,
                keyword: document.getElementById('filterKeyword').value.toLowerCase()
            };
            filteredData = queryDatabase.filter(function(item) {
                return (!filters.year || item.year === filters.year) &&
                    (!filters.unit || item.unit === filters.unit) &&
                    (!filters.category || item.category === filters.category) &&
                    (!filters.inspectionCategory || item.inspectionCategoryName === filters.inspectionCategory) &&
                    (!filters.division || item.divisionName === filters.division) &&
                    (!filters.status || item.status === filters.status) &&
                    (!filters.keyword || JSON.stringify(item).toLowerCase().includes(filters.keyword));
            });
            displayQueryResults(sortQueryResults(filteredData));
            updateStatistics(filteredData);
        }

        function stripHtml(html) {
            if (!html) return '';
            const doc = new DOMParser().parseFromString(html, 'text/html');
            return doc.body.textContent || "";
        }

        // åˆ‡æ›å±•é–‹/æ”¶åˆï¼ˆåªä¿ç•™æ›´å¤šæŒ‰éˆ•ï¼Œç§»é™¤è¤‡è£½ï¼‰
        function toggleContent(id, field) {
            const shortEl = document.getElementById(`${field}-short-${id}`);
            const fullEl = document.getElementById(`${field}-full-${id}`);
            const btn = document.getElementById(`${field}-toggle-${id}`);
            if (!shortEl || !fullEl || !btn) return;
            const isOpen = fullEl.classList.contains('open');
            if (isOpen) {
                fullEl.classList.remove('open');
                shortEl.style.display = 'block';
                btn.textContent = 'æ›´å¤š';
                btn.setAttribute('aria-expanded','false');
            } else {
                fullEl.classList.add('open');
                shortEl.style.display = 'none';
                btn.textContent = 'æ”¶åˆ';
                btn.setAttribute('aria-expanded','true');
            }
        }

        function displayQueryResults(data) {
            const tbody = document.getElementById('queryTableBody');
            document.getElementById('resultCount').textContent = `(${data.length} ç­†è³‡æ–™)`;
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" class="empty-message">æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(function(item){
                const statusClass = item.status === 'æŒçºŒåˆ—ç®¡' ? 'status-active' : (item.status === 'è§£é™¤åˆ—ç®¡' ? 'status-resolved' : 'status-self');

                function createPreviewHtml(fieldValue, fieldName, maxChars) {
                    const text = stripHtml(fieldValue).replace(/\s+/g,' ').trim();
                    const shortText = text.length > maxChars ? text.substring(0, maxChars) + '...' : text;
                    const hasMore = text.length > shortText.length;
                    const safeShort = escapeHtml(shortText);
                    const safeFull = escapeHtml(text);
                    return `<div class="cell-wrapper" aria-live="polite">
                                <div id="${fieldName}-short-${item.id}" class="cell-short ${hasMore ? 'has-more' : ''}" tabindex="0">${safeShort || '-'}</div>
                                <div id="${fieldName}-full-${item.id}" class="cell-full" aria-hidden="true">${safeFull || '-'}</div>
                                <div class="cell-controls" role="group" aria-label="${fieldName} æ“ä½œ">
                                    ${hasMore ? `<button class="more-btn" id="${fieldName}-toggle-${item.id}" onclick="event.stopPropagation(); toggleContent('${item.id}','${fieldName}')" aria-expanded="false">æ›´å¤š</button>` : ''}
                                </div>
                            </div>`;
                }

                const contentHtml = createPreviewHtml(item.content, 'content', MAX_CHARS.content);
                const handlingHtml = createPreviewHtml(getLatestHandling(item), 'handling', MAX_CHARS.handling);
                const reviewHtml = createPreviewHtml(getLatestReview(item), 'review', MAX_CHARS.review);

                let aiCell = `<div class="muted">å°šæœªåˆ†æ</div>`;
                if (item.aiResult) {
                    if (item.aiResult.status === 'analyzing') {
                        aiCell = `<div><span class="ai-badge ai-pending"><span class="spinner"></span>åˆ†æä¸­</span></div>`;
                    } else if (item.aiResult.status === 'done') {
                        const fulfill = (item.aiResult.fulfill || '').toString().trim();
                        const snippet = (item.aiResult.reason || '').toString();
                        if (fulfill === 'æ˜¯' || fulfill === 'Yes' || fulfill === 'Y') {
                            aiCell = `<div><span class="ai-badge ai-yes">æ˜¯</span></div><div style="margin-top:6px;color:#444;max-width:260px;font-size:13px;">${snippet.length>80? escapeHtml(snippet.substring(0,80)) + '...' : escapeHtml(snippet)}</div>`;
                        } else if (fulfill === 'å¦' || fulfill === 'No' || fulfill === 'N') {
                            aiCell = `<div><span class="ai-badge ai-no">å¦</span></div><div style="margin-top:6px;color:#444;max-width:260px;font-size:13px;">${snippet.length>80? escapeHtml(snippet.substring(0,80)) + '...' : escapeHtml(snippet)}</div>`;
                        } else {
                            aiCell = `<div><span class="ai-badge ai-done">${escapeHtml(fulfill || 'å·²åˆ†æ')}</span></div><div style="margin-top:6px;color:#444;max-width:260px;font-size:13px;">${snippet.length>80? escapeHtml(snippet.substring(0,80)) + '...' : escapeHtml(snippet)}</div>`;
                        }
                    } else if (item.aiResult.status === 'error') {
                        aiCell = `<div><span class="ai-badge ai-fail">åˆ†æå¤±æ•—</span></div><div style="color:#c00;font-size:12px;margin-top:6px;">${escapeHtml(item.aiResult.error||'')}</div>`;
                    }
                }

                return `<tr class="clickable-row" data-id="${item.id}" tabindex="0" onclick="openModal('${item.id}')">
                    <td class="preview-cell">${escapeHtml(item.year||'')}</td>
                    <td class="preview-cell">${escapeHtml(item.unit||'')}</td>
                    <td class="preview-cell">${escapeHtml(item.number||'')}</td>
                    <td class="preview-cell">${escapeHtml(item.category||'')}</td>
                    <td class="preview-cell">${escapeHtml(item.inspectionCategoryName||'')}</td>
                    <td class="preview-cell">${escapeHtml(item.divisionName||'')}</td>
                    <td class="preview-cell"><span class="status-badge ${statusClass}">${escapeHtml(item.status||'')}</span></td>
                    <td class="content-preview">${contentHtml}</td>
                    <td class="content-preview">${handlingHtml}</td>
                    <td class="content-preview">${reviewHtml}</td>
                    <td onclick="event.stopPropagation();" style="min-width:240px;">
                        <div style="display:flex;gap:8px;align-items:center;">
                            <button class="btn-sm btn-ai" onclick="event.stopPropagation(); analyzeItem('${item.id}')">ğŸ–¥ï¸ AIåˆ†æ</button>
                            <div style="flex:1;">${aiCell}</div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function openModal(id) {
            currentDetailId = id;
            const item = queryDatabase.find(r => String(r.id) === String(id));
            if (!item) return;
            document.getElementById('viewYear').textContent = item.year || '-';
            document.getElementById('viewUnit').textContent = item.unit || '-';
            document.getElementById('viewNumber').textContent = item.number || '-';
            document.getElementById('viewCategory').textContent = item.category || '-';
            document.getElementById('viewInspectionCategory').textContent = item.inspectionCategoryName || '-';
            document.getElementById('viewDivision').textContent = item.divisionName || '-';
            document.getElementById('viewStatus').textContent = item.status || '-';
            document.getElementById('viewContent').innerHTML = item.content || 'å°šç„¡å…§å®¹';
            analyzeAndDisplayRounds(item, document.getElementById('modalRounds'));

            const fulfilEl = document.getElementById('aiFulfill');
            const reasonEl = document.getElementById('aiReason');
            if (item.aiResult && item.aiResult.status === 'done') {
                const fulfill = (item.aiResult.fulfill || '').toString().trim();
                const reason = item.aiResult.reason || '';
                if (fulfill === 'æ˜¯' || fulfill === 'Yes' || fulfill === 'Y') {
                    fulfilEl.innerHTML = `<span class="ai-badge ai-yes">æ˜¯</span>`;
                } else if (fulfill === 'å¦' || fulfill === 'No' || fulfill === 'N') {
                    fulfilEl.innerHTML = `<span class="ai-badge ai-no">å¦</span>`;
                } else {
                    fulfilEl.innerHTML = `<span class="ai-badge ai-done">${fulfill ? fulfill : 'å·²åˆ†æ'}</span>`;
                }
                reasonEl.textContent = reason;
            } else if (item.aiResult && item.aiResult.status === 'analyzing') {
                fulfilEl.textContent = 'åˆ†æä¸­...';
                reasonEl.textContent = 'åˆ†æä¸­...';
            } else if (item.aiResult && item.aiResult.status === 'error') {
                fulfilEl.innerHTML = `<span class="ai-badge ai-fail">åˆ†æå¤±æ•—</span>`;
                reasonEl.textContent = item.aiResult.error || '';
            } else {
                fulfilEl.textContent = 'å°šæœªåˆ†æ';
                reasonEl.textContent = 'å°šæœªåˆ†æ';
            }

            const backdrop = document.getElementById('detailModalBackdrop');
            backdrop.classList.add('open');
            backdrop.setAttribute('aria-hidden', 'false');
            document.body.style.overflow = 'hidden';
            const panel = backdrop.querySelector('.modal-panel');
            if (panel) panel.focus && panel.setAttribute('tabindex', '-1'), panel.focus();
        }

        function closeModal() {
            const backdrop = document.getElementById('detailModalBackdrop');
            backdrop.classList.remove('open');
            backdrop.setAttribute('aria-hidden', 'true');
            document.body.style.overflow = '';
            currentDetailId = null;
        }

        function analyzeAndDisplayRounds(item, container) {
            container.innerHTML = '';
            let html = '';
            for (let i=1;i<=20;i++) {
                const handlingKey = i===1 ? 'handling' : `handling${i}`;
                const reviewKey = i===1 ? 'review' : `review${i}`;
                const dateKey = i===1 ? 'firstDate' : (i===2 ? 'secondDate' : (i===3 ? 'thirdDate' : `round${i}Date`));
                const actualDateKey = i===1 ? 'firstActualDate' : (i===2 ? 'secondActualDate' : (i===3 ? 'thirdActualDate' : `round${i}ActualDate`));
                const handlingContent = item[handlingKey];
                const reviewContent = item[reviewKey];
                const reviewDate = item[dateKey];
                const actualDate = item[actualDateKey];

                if (handlingContent || reviewContent || reviewDate || actualDate) {
                    html += `<div class="round-container">
                        <div class="round-header">ğŸ“ ç¬¬${i}æ¬¡å›å¾©èˆ‡å¯©æŸ¥è¨˜éŒ„</div>
                        <div class="round-body">
                            <div style="margin-bottom:8px;">
                                <strong>éµè·¯æ©Ÿæ§‹å›å¾©è¾¦ç†æƒ…å½¢ ${actualDate ? `(å¯¦éš›å›å¾©æ—¥æœŸ: ${actualDate})` : ''}</strong>
                                <div style="margin-top:6px;">${handlingContent || '<i>å°šç„¡å›å¾©å…§å®¹</i>'}</div>
                            </div>
                            <div>
                                <strong>å¯©æŸ¥æ„è¦‹ ${reviewDate ? `(å¯©æŸ¥ç™¼å‡½æ—¥æœŸ: ${reviewDate})` : ''}</strong>
                                <div style="margin-top:6px;">${reviewContent || '<i>å°šç„¡å¯©æŸ¥æ„è¦‹</i>'}</div>
                            </div>
                        </div>
                    </div>`;
                }
            }
            container.innerHTML = html || `<div class="empty-message">æš«ç„¡å›å¾©èˆ‡å¯©æŸ¥è¨˜éŒ„</div>`;
        }

        function sortQueryResults(data) {
            return data.sort(function(a,b){
                const ay = Number(a.year)||0;
                const by = Number(b.year)||0;
                if (by - ay !== 0) return by - ay;
                const an = a.number || '';
                const bn = b.number || '';
                return an.localeCompare(bn);
            });
        }

        function getLatestHandling(item) {
            for (let i=20;i>=1;i--) {
                const key = i===1 ? 'handling' : `handling${i}`;
                if (item[key]) return item[key];
            }
            return '';
        }
        function getLatestReview(item) {
            for (let i=20;i>=1;i--) {
                const key = i===1 ? 'review' : `review${i}`;
                if (item[key]) return item[key];
            }
            return '';
        }

        function updateStatistics(data) {
            document.getElementById('totalCount').textContent = data.length;
            document.getElementById('activeCount').textContent = data.filter(d => d.status === 'æŒçºŒåˆ—ç®¡').length;
            document.getElementById('resolvedCount').textContent = data.filter(d => ['è§£é™¤åˆ—ç®¡','è‡ªè¡Œåˆ—ç®¡'].includes(d.status)).length;
        }

        function resetQueryFilters() {
            document.querySelectorAll('.search-group select, .search-group input').forEach(function(el){ el.value = ''; });
            displayInitialQueryData();
            showMessage('å·²é‡è¨­ç¯©é¸æ¢ä»¶', 'success');
        }

        function exportQueryCSV() {
            const dataToExport = filteredData.length > 0 ? filteredData : queryDatabase;
            if (dataToExport.length === 0) { showMessage('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º', 'error'); return; }
            let csvContent = '\uFEFFå¹´åº¦,éµè·¯æ©Ÿæ§‹,ç·¨è™Ÿ,äº‹é …é¡åˆ¥,æª¢æŸ¥é¡åˆ¥,åˆ†çµ„,ç‹€æ…‹,å…§å®¹,æœ€æ–°è¾¦ç†æƒ…å½¢,æœ€æ–°å¯©æŸ¥æ„è¦‹\n';
            dataToExport.forEach(function(item){
                const row = [item.year, item.unit, item.number, item.category, item.inspectionCategoryName, item.divisionName, item.status, stripHtml(item.content), stripHtml(getLatestHandling(item)), stripHtml(getLatestReview(item))].map(function(f){ return `"${(f||'').toString().replace(/"/g,'""').replace(/\n/g,'\\r\\n')}"`; }).join(',');
                csvContent += row + '\n';
            });
            downloadFile(csvContent, 'SMS_Query_Export.csv', 'text/csv;charset=utf-8;');
            showMessage(`æˆåŠŸåŒ¯å‡º ${dataToExport.length} ç­†è³‡æ–™`, 'success');
        }

        function downloadFile(content, filename, mimeType) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(new Blob([content], { type: mimeType }));
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        function showMessage(message, type) {
            const el = document.getElementById('queryMessage');
            el.textContent = message;
            el.style.display = 'block';
            el.className = type === 'success' ? 'message success' : (type === 'error' ? 'message error' : 'empty-message');
            setTimeout(function(){ el.style.display = 'none'; }, 4200);
        }

        // åˆ†æå–®ç­†ï¼ˆæ”¹é€²ï¼šæ›´å‹å–„åœ°è™•ç†é JSON å›æ‡‰ä¸¦è¨˜éŒ„å…§å®¹ä»¥ä¾¿ Debugï¼‰
        async function analyzeItem(id) {
            const item = queryDatabase.find(r => String(r.id) === String(id));
            if (!item) return;
            if (item.aiResult && item.aiResult.status === 'analyzing') return;
            item.aiResult = { status: 'analyzing' };
            displayQueryResults(sortQueryResults(filteredData));
            if (currentDetailId && String(currentDetailId) === String(id)) {
                document.getElementById('aiFulfill').textContent = 'åˆ†æä¸­...';
                document.getElementById('aiReason').textContent = 'åˆ†æä¸­...';
            }
            try {
                const content = item.content || '';
                const rounds = collectAllRounds(item);

                // å¦‚æœä½ çš„å¾Œç«¯éƒ¨ç½²åœ¨ä¸åŒçš„ originï¼Œè«‹æŠŠä¸‹é¢è·¯å¾‘æ”¹ç‚ºå®Œæ•´ URLï¼Œä¾‹å¦‚ "https://api.example.com/api/gemini"
                const res = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ content, rounds })
                });

                const contentType = res.headers.get('content-type') || '';
                const rawText = await res.text(); // å…ˆå–æ–‡å­—ï¼Œé¿å…ç›´æ¥è§£æå¤±æ•—é€ æˆ Uncaught
                if (!res.ok) {
                    // è‹¥å¾Œç«¯å›å‚³é 2xxï¼Œå˜—è©¦è§£æéŒ¯èª¤è³‡è¨Š
                    let parsedError = rawText;
                    try {
                        if (contentType.includes('application/json')) {
                            parsedError = JSON.parse(rawText);
                        }
                    } catch (e) {
                        // leave parsedError as rawText
                    }
                    item.aiResult = { status: 'error', error: `Server ${res.status}: ${typeof parsedError === 'string' ? parsedError : JSON.stringify(parsedError)}` };
                    console.error('AI API non-ok response:', res.status, rawText);
                } else {
                    // å›å‚³ç‚º 2xxï¼šä½†å¯èƒ½æ˜¯ HTMLï¼ˆcontent-type å« text/htmlï¼‰æˆ– JSON
                    if (contentType.includes('application/json')) {
                        let result;
                        try {
                            result = JSON.parse(rawText);
                        } catch (e) {
                            item.aiResult = { status: 'error', error: 'è§£æ JSON å¤±æ•—' };
                            console.error('JSON parse error:', e, rawText);
                        }
                        if (result) {
                            if (result.error) {
                                item.aiResult = { status: 'error', error: result.error };
                            } else {
                                item.aiResult = { status: 'done', fulfill: result.fulfill || '', reason: result.reason || '' };
                            }
                        }
                    } else {
                        // é JSON å›æ‡‰ï¼ˆä¾‹å¦‚ HTMLï¼‰â€”â€”è¨˜éŒ„ä¸¦å›å ±åˆ° UI
                        item.aiResult = { status: 'error', error: `é JSON å›æ‡‰ï¼ˆContent-Type: ${contentType}ï¼‰ã€‚ä¼ºæœå™¨å›æ‡‰ç‰‡æ®µ: ${rawText.substring(0,500)}` };
                        console.error('Non-JSON response from /api/gemini:', res.status, contentType, rawText);
                    }
                }
            } catch (e) {
                item.aiResult = { status: 'error', error: e.message };
                console.error('analyzeItem error:', e);
            }
            displayQueryResults(sortQueryResults(filteredData));
            if (currentDetailId && String(currentDetailId) === String(id)) {
                const ai = item.aiResult;
                const fulfilEl = document.getElementById('aiFulfill');
                const reasonEl = document.getElementById('aiReason');
                if (ai.status === 'done') {
                    const fulfill = (ai.fulfill || '').toString().trim();
                    if (fulfill === 'æ˜¯' || fulfill === 'Yes' || fulfill === 'Y') {
                        fulfilEl.innerHTML = `<span class="ai-badge ai-yes">æ˜¯</span>`;
                    } else if (fulfill === 'å¦' || fulfill === 'No' || fulfill === 'N') {
                        fulfilEl.innerHTML = `<span class="ai-badge ai-no">å¦</span>`;
                    } else {
                        fulfilEl.innerHTML = `<span class="ai-badge ai-done">${fulfill ? fulfill : 'å·²åˆ†æ'}</span>`;
                    }
                    reasonEl.textContent = ai.reason || '';
                } else if (ai.status === 'error') {
                    fulfilEl.innerHTML = `<span class="ai-badge ai-fail">åˆ†æå¤±æ•—</span>`;
                    reasonEl.textContent = ai.error || '';
                }
            }
            return item.aiResult;
        }

        async function analyzeAllDisplayed() {
            const list = filteredData.length > 0 ? filteredData : queryDatabase;
            if (!list || list.length === 0) { showMessage('ç›®å‰ç„¡è³‡æ–™å¯åˆ†æ', 'error'); return; }
            showMessage('é–‹å§‹ä¾åºåˆ†ææ¯ç­†ï¼ˆå¯èƒ½è¼ƒä¹…ï¼‰ï¼Œè«‹ç¨å€™...', 'success');
            for (let i=0;i<list.length;i++) {
                const item = list[i];
                if (item.aiResult && item.aiResult.status === 'done') continue;
                await analyzeItem(item.id);
                await new Promise(r => setTimeout(r, 220));
            }
            showMessage('ä¸€éµåˆ†æå®Œæˆï¼ˆå·²æ›´æ–°è¡¨æ ¼ä¸­çš„ AI çµæœï¼‰', 'success');
        }

        function runAIAnalysis() {
            if (!currentDetailId) { document.getElementById('aiReason').textContent = 'è«‹å…ˆé¸æ“‡è¦åˆ†æçš„é …ç›®'; return; }
            analyzeItem(currentDetailId);
        }

        function escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
        }

        // collect rounds (unchanged)
        function collectAllRounds(item) {
            const rounds = [];
            for (let i=1;i<=20;i++) {
                const handlingKey = i===1 ? 'handling' : `handling${i}`;
                const reviewKey = i===1 ? 'review' : `review${i}`;
                if (item[handlingKey] || item[reviewKey]) rounds.push({ handling: item[handlingKey]||'', review: item[reviewKey]||'' });
            }
            return rounds;
        }
    </script>
</body>
</html>